#!/bin/bash
set -euo pipefail

# TOT Commit-Message Hook
# Enforces: WI-NNN type(scope): description
# Based on Conventional Commits v1.0.0
# Chains with original commit-msg hook if present.

PROJ_DIR="$(git rev-parse --show-toplevel)"
MSG_FILE="$1"
FIRST_LINE=$(head -1 "$MSG_FILE")

# ─── Chain with original hook ───
if [ -f "$PROJ_DIR/.tot-hooks/original-commit-msg" ]; then
    "$PROJ_DIR/.tot-hooks/original-commit-msg" "$MSG_FILE" || exit 1
fi

# ─── Allow merge commits ───
if echo "$FIRST_LINE" | grep -qE '^Merge '; then
    exit 0
fi

# ─── Only enforce on tot/* branches ───
BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$BRANCH" != tot/* ]]; then
    exit 0
fi

# ─── Extract WI number from branch ───
# Supports both tot/<type>/WI-NNN-desc and legacy tot/WI-NNN-desc
WI_FROM_BRANCH=$(echo "$BRANCH" | grep -oP 'WI-\K[0-9]+' | head -1)

# ─── Validate format ───
# Format: WI-NNN type(scope): description
# - WI-NNN required (or TOT for setup commits)
# - type required (conventional commits)
# - (scope) optional
# - ! optional (breaking change)
# - description required, starts lowercase
PATTERN='^(WI-[0-9]+|TOT) (feat|fix|build|chore|ci|docs|style|refactor|perf|test|revert)(\([a-zA-Z0-9_/-]+\))?(!)?: [a-z]'

if ! echo "$FIRST_LINE" | grep -qE "$PATTERN"; then
    echo "BLOCKED: Commit message does not follow required format."
    echo ""
    echo "  Format:  WI-NNN type(scope): description"
    echo ""
    echo "  WI-NNN:  must match active work item (or TOT for setup)"
    echo "  type:    feat fix build chore ci docs style refactor perf test revert"
    echo "  (scope): optional, e.g. (api), (auth), (db)"
    echo "  !:       optional, marks breaking change"
    echo "  desc:    starts lowercase"
    echo ""
    echo "  Examples:"
    echo "    WI-001 refactor(src): port canvas class to C89 struct"
    echo "    WI-001 fix(src): handle null pointer in path builder"
    echo "    WI-004 chore: replace cmake with makefile"
    echo ""
    echo "  Got: $FIRST_LINE"
    exit 1
fi

# ─── Validate WI number matches branch ───
WI_FROM_MSG=$(echo "$FIRST_LINE" | grep -oP '^WI-\K[0-9]+' || echo "")
if [ -n "$WI_FROM_BRANCH" ] && [ -n "$WI_FROM_MSG" ] && [ "$WI_FROM_MSG" != "$WI_FROM_BRANCH" ]; then
    echo "BLOCKED: Commit references WI-$WI_FROM_MSG but branch is for WI-$WI_FROM_BRANCH."
    exit 1
fi

# ─── Subject line length (72 chars max) ───
if [ ${#FIRST_LINE} -gt 72 ]; then
    echo "BLOCKED: Subject line is ${#FIRST_LINE} chars (max 72)."
    echo "  Got: $FIRST_LINE"
    exit 1
fi

# ─── Body separation (blank line after subject) ───
LINE_COUNT=$(wc -l < "$MSG_FILE")
if [ "$LINE_COUNT" -gt 1 ]; then
    SECOND_LINE=$(sed -n '2p' "$MSG_FILE")
    if [ -n "$SECOND_LINE" ]; then
        echo "BLOCKED: Second line must be blank (separates subject from body)."
        exit 1
    fi
fi
